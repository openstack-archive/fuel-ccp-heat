service:
  name: heat-api
  ports:
    - heat_api_port
  node-selector:
    openstack-controller: "true"
  containers:
    - name: heat-api
      image: heat-api
      # TODO(drusskikh): add probes
      probes:
        readiness: "true"
        liveness: "true"
      pre:
        - name: heat-db-create
          dependencies:
            - mariadb
          type: single
          command:
            mysql -u root -p{{ db_root_password }} -h mariadb -e "create database {{ heat_db_name }};
            grant all privileges on {{ heat_db_name }}.* to '{{ heat_db_username }}'@'%' identified by '{{ heat_db_password }}';"
        - name: heat-db-sync
          files:
            - heat-conf
          dependencies:
            - heat-db-create
          type: single
          command: heat-manage db_sync
        - name: heat-user-create
          dependencies:
            - keystone-create-project
          type: single
          command:
              openstack user create --domain default --password {{ heat_password }} {{ heat_user }}
        - name: heat-role-add
          dependencies:
            - heat-user-create
          type: single
          command:
              openstack role add --project {{ openstack_project_name }} --user {{ heat_user }} admin
        - name: heat-service-create
          dependencies:
            - heat-role-add
          type: single
          command:
              openstack service create --name heat --description "OpenStack orchestration service" orchestration
        - name: heat-create-public-endpoint
          dependencies:
            - heat-service-create
          type: single
          command:
              openstack endpoint create --region RegionOne orchestration public http://heat-api:{{ heat_api_port }}/v1/%\(tenant_id\)s
        - name: heat-create-internal-endpoint
          dependencies:
            - heat-create-public-endpoint
          type: single
          command:
              openstack endpoint create --region RegionOne orchestration internal http://heat-api:{{ heat_api_port }}/v1/%\(tenant_id\)s
        - name: heat-create-admin-endpoint
          dependencies:
            - heat-create-internal-endpoint
          type: single
          command:
              openstack endpoint create --region RegionOne orchestration admin http://heat-api:{{ heat_api_port }}/v1/%\(tenant_id\)s
      daemon:
        name: heat-api
        files:
          - heat-conf
        command: heat-api

files:
  heat-conf:
    path: /etc/heat/heat.conf
    content: heat.conf.j2
